{% extends "base.html" %}
{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python üêç Code Learner</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script src="{{ url_for('static', filename='js/progress-tracker.js') }}"></script>
    <style>
        zero-md {
            --md-title-color: #1e293b;
            --md-text-color: #334155;
            --md-link-color: #4f46e5;
            --md-code-bg: #f8fafc;
            --md-code-text: #1e293b;
            --md-code-font: 'Monaco', 'Consolas', monospace;
            --md-font: system-ui, -apple-system, sans-serif;
        }
    </style>
</head>

<body class="bg-gray-50" 
      data-chapter-id="{{ chapter_id }}" 
      data-page-id="{{ page_id }}" 
      data-page-title="{{ page_title }}">
    <!-- Learning Content -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">{{ page_title }}</h2>
            <div class="p-6" id="markdown-content">
                <zero-md src="{{ url_for('static', filename='docs/chapter1_example1.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Interactive Code Editor -->
    <div class="max-w-4xl mx-auto">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Interactive Python Editor</h3>
                        <p class="mt-1 text-sm text-gray-500">Write and execute Python code in real-time</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButton" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButton" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter1_ex1">
                            Run Code ‚åò+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editor" class="h-64 border-b border-gray-100"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="output" class="bg-white border border-gray-200 rounded-md p-4 text-sm font-mono text-gray-800 overflow-auto max-h-48"></pre>
            </div>
        </div>
    </div>
    
    <!-- Mark as Completed Button -->
    <div class="max-w-4xl mx-auto mt-8 mb-16 text-center">
        <button id="markCompletedButton" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Mark Chapter as Completed
        </button>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // The progress tracker will auto-initialize from body data attributes
            // No need to call any init function manually
        });

        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            window.editor = monaco.editor.create(document.getElementById('editor'), {
                value: "",
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });

            // Load Python file content dynamically
            fetch("{{ url_for('static', filename='python/chapter1_example1.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editor.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));
        });

        async function loadPyodideAndRun() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            pyodide.globals.set("input", (promptText) => prompt(promptText)); // Replace input() with JS prompt()
            return pyodide;
        }
        
        let pyodideReady = loadPyodideAndRun();

        async function runPythonCode() {
            let pyodide = await pyodideReady;
            const code = window.editor.getValue();

            try {
                // Redirect stdout to capture print() output
                pyodide.runPython(`
                    import sys
                    from js import document

                    class PyodideStdout:
                        def __init__(self):
                            self.output = []

                        def write(self, text):
                            self.output.append(text)
                            # Send output to JavaScript function
                            send_output(text)

                        def flush(self):
                            pass  # Needed for compatibility

                    def send_output(text):
                        output_element = document.getElementById("output")
                        output_element.textContent += text  # Append new output

                    sys.stdout = PyodideStdout()  # Redirect stdout
                `);

                // Execute user Python code and get return value
                let result = await pyodide.runPythonAsync(code);

                // Display both print() outputs and return values
                let outputElement = document.getElementById("output");
                if (result !== undefined && result !== null) {
                    outputElement.textContent += `\np${result}`;
                    // outputElement.textContent += `\nReturn Value: ${result}`;
                }

                // Track exercise attempt
                if (document.getElementById("runButton").hasAttribute("data-exercise-id")) {
                    const exerciseId = document.getElementById("runButton").getAttribute("data-exercise-id");
                    const success = !outputElement.textContent.includes("Error:");
                    ProgressTracker.trackExercise({
                        id: exerciseId,
                        title: "Chapter 1 - Hello World Exercise",
                        code: code,
                        isCorrect: success
                    });
                }

            } catch (err) {
                document.getElementById("output").textContent = "Error: " + err;
                
                // Track failed exercise attempt
                if (document.getElementById("runButton").hasAttribute("data-exercise-id")) {
                    const exerciseId = document.getElementById("runButton").getAttribute("data-exercise-id");
                    ProgressTracker.trackExercise({
                        id: exerciseId,
                        title: "Chapter 1 - Hello World Exercise",
                        code: code,
                        isCorrect: false
                    });
                }
            }
        }

        // Function to clear the console output
        function clearConsole() {
            document.getElementById("output").textContent = "";
        }

        document.getElementById("runButton").addEventListener("click", function() {
            runPythonCode();
            // Track the button click event
            ProgressTracker.trackEvent('exercise_run', {
                exercise_id: "chapter1_ex1"
            });
        });
        
        document.getElementById("clearButton").addEventListener("click", function() {
            clearConsole();
            // Track the button click event
            ProgressTracker.trackEvent('console_clear');
        });

        document.addEventListener("keydown", function (event) {
            if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
                event.preventDefault();
                runPythonCode();
                // Track the keyboard shortcut event
                ProgressTracker.trackEvent('exercise_run_shortcut', {
                    exercise_id: "chapter1_ex1"
                });
            }
        });
        
        // Mark as Completed button handler
        document.getElementById("markCompletedButton").addEventListener("click", function() {
            // Track the completion event
            ProgressTracker.trackEvent('chapter_completed', {
                completion_type: 'user_marked'
            });
            
            // Provide visual feedback
            const button = document.getElementById("markCompletedButton");
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-gray-400', 'cursor-not-allowed');
            button.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Chapter Marked as Complete!
            `;
            button.disabled = true;
            
            // Show a success message
            alert("Congratulations! This chapter has been marked as completed.");
            
            // Redirect to progress dashboard after a short delay
            setTimeout(() => {
                window.location.href = "{{ url_for('progress.user_dashboard') }}";
            }, 1500);
        });
    </script>
</body>

{% endblock %}
