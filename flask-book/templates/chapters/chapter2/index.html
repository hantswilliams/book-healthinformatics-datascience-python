{% extends "base.html" %}
{% block content %}

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pandas for Health Informatics</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs/loader.js"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.26.4/full/pyodide.js"></script>
    <script src="{{ url_for('static', filename='js/progress-tracker.js') }}"></script>
    <style>
        zero-md {
            --md-title-color: #1e293b;
            --md-text-color: #334155;
            --md-link-color: #4f46e5;
            --md-code-bg: #f8fafc;
            --md-code-text: #1e293b;
            --md-code-font: 'Monaco', 'Consolas', monospace;
            --md-font: system-ui, -apple-system, sans-serif;
        }
        
        .interactive-section {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        
        .interactive-section .editor-container {
            height: 300px;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        
        .interactive-section .output-container {
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-top: 1rem;
            min-height: 100px;
            max-height: 200px;
            overflow: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.875rem;
        }
    </style>
</head>

<body class="bg-gray-50" 
      data-chapter-id="chapter2" 
      data-page-id="pandas" 
      data-page-title="Intro to pandas for Importing Data">
    
    <!-- Learning Content - Part 1: Introduction -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part1">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Intro to pandas for Importing Data</h2>
            </div>
            <div class="p-6" id="markdown-content-part1">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section1_intro.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Interactive Section 1: Basic DataFrame Creation -->
    <div class="max-w-4xl mx-auto interactive-section">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Interactive Example: Creating Your First DataFrame</h3>
                        <p class="mt-1 text-sm text-gray-500">Try creating a simple pandas DataFrame from a dictionary</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButton1" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButton1" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter2_ex1">
                            Run Code ⌘+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editor1" class="editor-container"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="output1" class="output-container"></pre>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 2: Pandas Functions -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part2">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Pandas Functions and Capabilities</h2>
            </div>
            <div class="p-6" id="markdown-content-part2">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section2_functions.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 3: Loading Data -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part3">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Loading Data with Pandas</h2>
            </div>
            <div class="p-6" id="markdown-content-part3">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section3_loading.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 4: Reading Methods -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part4">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Reading Methods in Pandas</h2>
            </div>
            <div class="p-6" id="markdown-content-part4">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section4_reading_methods.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Interactive Section 2: Reading Data from Sources -->
    <div class="max-w-4xl mx-auto interactive-section">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Interactive Example: Reading Data from Different Sources</h3>
                        <p class="mt-1 text-sm text-gray-500">Try loading data from CSV, JSON, and other formats</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButton2" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButton2" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter2_ex2">
                            Run Code ⌘+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editor2" class="editor-container"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="output2" class="output-container"></pre>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 5: DataFrames -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part5">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Pandas DataFrames and Data Manipulation</h2>
            </div>
            <div class="p-6" id="markdown-content-part5">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section5_dataframes.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Interactive Section 3: Data Manipulation -->
    <div class="max-w-4xl mx-auto interactive-section">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Interactive Example: Data Manipulation</h3>
                        <p class="mt-1 text-sm text-gray-500">Try SQL-like operations on pandas DataFrames</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButton3" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButton3" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter2_ex3">
                            Run Code ⌘+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editor3" class="editor-container"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="output3" class="output-container"></pre>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 6: Loading CSV -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part6">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Working with CSV Files</h2>
            </div>
            <div class="p-6" id="markdown-content-part6">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section6_loading_csv.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 7: Loading Options -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part7">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Advanced Loading Options</h2>
            </div>
            <div class="p-6" id="markdown-content-part7">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section7_loading_options.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 8: Excel and JSON -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part8">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Working with Excel and JSON</h2>
            </div>
            <div class="p-6" id="markdown-content-part8">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section8_excel_json.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 9: JSON Examples -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part9">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">JSON Data in Healthcare</h2>
            </div>
            <div class="p-6" id="markdown-content-part9">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section9_json_result.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Interactive Section 4: JSON and API Data -->
    <div class="max-w-4xl mx-auto interactive-section">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Interactive Example: Working with JSON and APIs</h3>
                        <p class="mt-1 text-sm text-gray-500">Try working with JSON data and API-like responses</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButton4" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButton4" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter2_ex4">
                            Run Code ⌘+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editor4" class="editor-container"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="output4" class="output-container"></pre>
            </div>
        </div>
    </div>

    <!-- Learning Content - Part 10: SQL API -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part10">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Pandas SQL API</h2>
            </div>
            <div class="p-6" id="markdown-content-part10">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section10_sql_api.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>
    
    <!-- Learning Content - Part 11: Handling Missing Data -->
    <div class="max-w-4xl mx-auto mb-8 learning-content" id="content-container-part11">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 bg-white p-6">
                <h2 class="text-lg font-semibold text-gray-900">Handling Missing Data</h2>
            </div>
            <div class="p-6" id="markdown-content-part11">
                <zero-md src="{{ url_for('static', filename='docs/chapter2/section11_conclusion.md') }}">
                    <template>
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/sindresorhus/github-markdown-css@4/github-markdown.min.css">
                        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/PrismJS/prism@1/themes/prism.min.css">
                    </template>
                </zero-md>
            </div>
        </div>
    </div>

    <!-- Interactive Section 5: Handling Missing Data -->
    <div class="max-w-4xl mx-auto interactive-section">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Interactive Example: Handling Missing Data</h3>
                        <p class="mt-1 text-sm text-gray-500">Try methods for detecting and handling missing values</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButton5" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButton5" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter2_ex5">
                            Run Code ⌘+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editor5" class="editor-container"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="output5" class="output-container"></pre>
            </div>
        </div>
    </div>

    <!-- Final Comprehensive Code Example -->
    <div class="max-w-4xl mx-auto">
        <div class="bg-white shadow-sm rounded-xl overflow-hidden">
            <div class="border-b border-gray-100 p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Comprehensive Example: Healthcare Data Analysis with pandas</h3>
                        <p class="mt-1 text-sm text-gray-500">Run a complete example bringing together all the concepts</p>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button id="clearButtonFinal" class="inline-flex items-center px-3 py-1.5 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Clear Console
                        </button>
                        <button id="runButtonFinal" class="inline-flex items-center px-4 py-1.5 border border-transparent text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500" data-exercise-id="chapter2_exFinal">
                            Run Code ⌘+Enter
                        </button>
                    </div>
                </div>
            </div>
            <div id="editorFinal" class="editor-container h-64 border-b border-gray-100"></div>
            <div class="p-6 bg-gray-50">
                <h4 class="text-sm font-medium text-gray-900 mb-2">Output Console</h4>
                <pre id="outputFinal" class="output-container bg-white border border-gray-200 rounded-md p-4 text-sm font-mono text-gray-800 overflow-auto max-h-48"></pre>
            </div>
        </div>
    </div>
    
    <!-- Mark as Completed Button -->
    <div class="max-w-4xl mx-auto mt-8 mb-16 text-center">
        <button id="markCompletedButton" class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Mark Chapter as Completed
        </button>
    </div>
    
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // The progress tracker will auto-initialize from body data attributes
            // No need to call any init function manually
        });

        // Code editor initialization
        require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.41.0/min/vs' } });
        require(['vs/editor/editor.main'], function () {
            // Initialize all editors
            window.editor1 = monaco.editor.create(document.getElementById('editor1'), {
                value: '',
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });
            
            window.editor2 = monaco.editor.create(document.getElementById('editor2'), {
                value: '',
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });
            
            window.editor3 = monaco.editor.create(document.getElementById('editor3'), {
                value: '',
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });
            
            window.editor4 = monaco.editor.create(document.getElementById('editor4'), {
                value: '',
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });

            window.editor5 = monaco.editor.create(document.getElementById('editor5'), {
                value: '',
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });

            window.editorFinal = monaco.editor.create(document.getElementById('editorFinal'), {
                value: '',
                language: "python",
                theme: "vs-dark",
                automaticLayout: true
            });

            // Load Python file content dynamically for each editor
            fetch("{{ url_for('static', filename='python/chapter2_example1.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editor1.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));
                
            fetch("{{ url_for('static', filename='python/chapter2_example2.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editor2.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));
                
            fetch("{{ url_for('static', filename='python/chapter2_example3.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editor3.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));
                
            fetch("{{ url_for('static', filename='python/chapter2_example5.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editor4.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));
                
            fetch("{{ url_for('static', filename='python/chapter2_example4.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editor5.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));

            fetch("{{ url_for('static', filename='python/chapter2_pandas_examples.py') }}")
                .then(response => response.text())
                .then(data => {
                    window.editorFinal.setValue(data);
                })
                .catch(error => console.error("Error loading Python file:", error));
        });

        // Pyodide setup
        async function loadPyodideAndRun() {
            let pyodide = await loadPyodide();
            await pyodide.loadPackage("micropip");
            await pyodide.runPythonAsync(`
                import micropip
                await micropip.install('pandas')
            `);
            pyodide.globals.set("input", (promptText) => prompt(promptText)); // Replace input() with JS prompt()
            return pyodide;
        }
        
        let pyodideReady = loadPyodideAndRun();

        // Function to run Python code in a specific editor and output to a specific element
        async function runPythonCode(editorId, outputId) {
            let pyodide = await pyodideReady;
            const editor = window[editorId];
            const outputElement = document.getElementById(outputId);
            const code = editor.getValue();
            
            outputElement.textContent = "Running...";

            try {
                // Set up stdout capture for this specific output element
                pyodide.runPython(`
                    import sys
                    from js import document

                    class PyodideStdout:
                        def __init__(self, output_id):
                            self.output = []
                            self.output_id = output_id

                        def write(self, text):
                            self.output.append(text)
                            # Send output to JavaScript function
                            send_output(text, self.output_id)

                        def flush(self):
                            pass  # Needed for compatibility

                    def send_output(text, output_id):
                        output_element = document.getElementById(output_id)
                        if output_element.textContent == "Running...":
                            output_element.textContent = text
                        else:
                            output_element.textContent += text

                    sys.stdout = PyodideStdout("${outputId}")  # Redirect stdout
                `);

                // Execute user Python code and get return value
                let result = await pyodide.runPythonAsync(code);

                // Display return value if not None
                if (result !== undefined && result !== null) {
                    outputElement.textContent += `\n\nReturn Value: ${result}`;
                }

                // Track exercise attempt
                const runButton = document.querySelector(`button[id^="runButton"][data-exercise-id]`);
                if (runButton && runButton.hasAttribute("data-exercise-id")) {
                    const exerciseId = runButton.getAttribute("data-exercise-id");
                    const success = !outputElement.textContent.includes("Error:");
                    ProgressTracker.trackExercise({
                        id: exerciseId,
                        title: "Chapter 2 - Pandas Exercise",
                        code: code,
                        isCorrect: success
                    });
                }

            } catch (err) {
                outputElement.textContent = "Error: " + err;
                
                // Track failed exercise attempt
                const runButton = document.querySelector(`button[id^="runButton"][data-exercise-id]`);
                if (runButton && runButton.hasAttribute("data-exercise-id")) {
                    const exerciseId = runButton.getAttribute("data-exercise-id");
                    ProgressTracker.trackExercise({
                        id: exerciseId,
                        title: "Chapter 2 - Pandas Exercise",
                        code: code,
                        isCorrect: false
                    });
                }
            }
        }

        // Clear console function
        function clearConsole(outputId) {
            document.getElementById(outputId).textContent = "";
        }

        // Event listeners for interactive sections
        document.getElementById("runButton1").addEventListener("click", function() {
            runPythonCode("editor1", "output1");
            ProgressTracker.trackEvent('exercise_run', { exercise_id: "chapter2_ex1" });
        });
        
        document.getElementById("clearButton1").addEventListener("click", function() {
            clearConsole("output1");
            ProgressTracker.trackEvent('console_clear');
        });
        
        document.getElementById("runButton2").addEventListener("click", function() {
            runPythonCode("editor2", "output2");
            ProgressTracker.trackEvent('exercise_run', { exercise_id: "chapter2_ex2" });
        });
        
        document.getElementById("clearButton2").addEventListener("click", function() {
            clearConsole("output2");
            ProgressTracker.trackEvent('console_clear');
        });
        
        document.getElementById("runButton3").addEventListener("click", function() {
            runPythonCode("editor3", "output3");
            ProgressTracker.trackEvent('exercise_run', { exercise_id: "chapter2_ex3" });
        });
        
        document.getElementById("clearButton3").addEventListener("click", function() {
            clearConsole("output3");
            ProgressTracker.trackEvent('console_clear');
        });
        
        document.getElementById("runButton4").addEventListener("click", function() {
            runPythonCode("editor4", "output4");
            ProgressTracker.trackEvent('exercise_run', { exercise_id: "chapter2_ex4" });
        });
        
        document.getElementById("clearButton4").addEventListener("click", function() {
            clearConsole("output4");
            ProgressTracker.trackEvent('console_clear');
        });
        
        document.getElementById("runButton5").addEventListener("click", function() {
            runPythonCode("editor5", "output5");
            ProgressTracker.trackEvent('exercise_run', { exercise_id: "chapter2_ex5" });
        });
        
        document.getElementById("clearButton5").addEventListener("click", function() {
            clearConsole("output5");
            ProgressTracker.trackEvent('console_clear');
        });
        
        document.getElementById("runButtonFinal").addEventListener("click", function() {
            runPythonCode("editorFinal", "outputFinal");
            ProgressTracker.trackEvent('exercise_run', { exercise_id: "chapter2_exFinal" });
        });
        
        document.getElementById("clearButtonFinal").addEventListener("click", function() {
            clearConsole("outputFinal");
            ProgressTracker.trackEvent('console_clear');
        });

        // Keyboard shortcut handler
        document.addEventListener("keydown", function (event) {
            if ((event.metaKey || event.ctrlKey) && event.key === "Enter") {
                event.preventDefault();
                
                // Determine which editor is currently focused
                const activeElement = document.activeElement;
                const editorContainers = ["editor1", "editor2", "editor3", "editor4", "editor5", "editorFinal"];
                
                for (let editorId of editorContainers) {
                    if (activeElement.closest(`#${editorId}`)) {
                        const outputId = editorId.replace("editor", "output");
                        runPythonCode(editorId, outputId);
                        ProgressTracker.trackEvent('exercise_run_shortcut', {
                            exercise_id: editorId.includes("Final") ? "chapter2_exFinal" : `chapter2_ex${editorId.replace("editor", "")}`
                        });
                        break;
                    }
                }
            }
        });
        
        // Mark as Completed button handler
        document.getElementById("markCompletedButton").addEventListener("click", function() {
            // Track the completion event
            ProgressTracker.trackEvent('chapter_completed', {
                completion_type: 'user_marked'
            });
            
            // Provide visual feedback
            const button = document.getElementById("markCompletedButton");
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-gray-400', 'cursor-not-allowed');
            button.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Chapter Marked as Complete!
            `;
            button.disabled = true;
            
            // Show a success message
            alert("Congratulations! This chapter has been marked as completed.");
            
            // Redirect to progress dashboard after a short delay
            setTimeout(() => {
                window.location.href = "{{ url_for('progress.user_dashboard') }}";
            }, 1500);
        });
    </script>
</body>

{% endblock %}
